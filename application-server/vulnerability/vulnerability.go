package vulnerability

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"os"

	"github.com/arora-aditya/monorepo/application-server/graph/model"
)

const VULNERABILITIES_FILE = "./vulnerability/frontend_data.json"

func GetAllVulnerabilities() []*model.Vulnerability {
	dir, err := os.Getwd()
	fmt.Println(dir)
	jsonFile, err := os.Open(VULNERABILITIES_FILE)
	if err != nil {
		fmt.Println(err)
	}

	byteValue, _ := ioutil.ReadAll(jsonFile)
	all_vulnerabilities := []*model.Vulnerability{}
	json.Unmarshal(byteValue, &all_vulnerabilities)

	return all_vulnerabilities
}

func IsVulnerable(dependency *model.Dependency, vulnerabilities []*model.Vulnerability) (bool, *model.Vulnerability) {
	for _, vulnerability := range vulnerabilities {
		if vulnerability.Name == dependency.Name && dependency.Version <= vulnerability.PatchedVersions[0] {
			return true, vulnerability
		}
	}
	return false, nil
}
