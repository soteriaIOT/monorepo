package vulnerability

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"os"

	"github.com/arora-aditya/monorepo/application-server/graph/model"
)

const VULNERABILITIES_FILE = "./application-server/vulnerability/frontend_data.json"

func GetAllVulnerabilities() []*model.Vulnerability {
	jsonFile, err := os.Open(VULNERABILITIES_FILE)
	if err != nil {
		fmt.Println(err)
	}

	byteValue, _ := ioutil.ReadAll(jsonFile)
	all_vulnerabilities := []*model.Vulnerability{}
	json.Unmarshal(byteValue, &all_vulnerabilities)

	for _, vulnerability := range all_vulnerabilities {
		vulnerability.Dependency = &model.Dependency{
			Name: vulnerability.Name,
		}
	}

	return all_vulnerabilities
}

func IsVulnerable(dependency *model.Dependency, vulnerabilities []*model.Vulnerability) ([]*model.Vulnerability) {
	vulns := []*model.Vulnerability{}
	for _, vulnerability := range vulnerabilities {
		if vulnerability.Name == dependency.Name && dependency.Version < vulnerability.PatchedVersions[0] {
			vulns = append(vulns, vulnerability)
		}
	}
	return vulns
}
